# セキュリティ対策実施報告書 (Neura Craft Backend)

## 概要

本ドキュメントは、Neura Craft Backend に対して実施されたセキュリティ診断結果、および実施済みの修正対応、今後推奨される運用対策についてまとめたものです。

## ✅ 実施済みの修正 (Fixed)

以下の重大な脆弱性および不備について修正を完了しました。

### 1. 認証情報のログ出力削除 (Critical)

- **問題**: `get_password_hash` および `register_user` メソッドにおいて、ユーザーのパスワード（平文）がログに出力されていた。
- **対策**: 該当箇所の `logger.info` およびエラーログ内のパスワード出力を完全に削除。
- **ファイル**: `app/core/security.py`, `app/services/auth_service.py`

### 2. DoS 攻撃対策・巨大ファイル対応 (Major)

- **問題**: ファイルアップロード時に `await uploaded_file.read()` で全データをメモリに展開していたため、巨大ファイル送信によるサーバークラッシュ（DoS）のリスクがあった。
- **対策**:
  - `Content-Length` ヘッダーによるサイズチェック（上限 100MB）を追加。
  - メモリへの一括読み込みを廃止し、ストリーミング形式で Azure Blob Storage へ転送するように変更。
- **ファイル**: `app/api/v1/routes_files.py`, `app/services/blob_service.py`

### 3. ファイル拡張子の厳格な制限 (Major)

- **問題**: アップロードファイルの拡張子チェックが存在せず、実行ファイル等のアップロードが可能だった。
- **対策**: ホワイトリスト方式による拡張子検証を追加。許可リスト以外は `400 Bad Request` で拒否。
  - **許可リスト**: `.pdf`, `.docx`, `.xlsx`, `.pptx`, `.txt`, `.doc`, `.xls`, `.ppt`
- **ファイル**: `app/api/v1/routes_files.py`

### 4. Secret Key の設定厳格化 (Major)

- **問題**: `SECRET_KEY` のデフォルト値がコード内にハードコードされており、設定漏れ時に脆弱な状態で稼働するリスクがあった。
- **対策**: `Field(default=...)` を削除し、環境変数（または `.env`）での設定を必須化。設定がない場合はサーバーが起動しないように変更。
  - ※ 注: Azure 環境等での設定が必須となります。
- **ファイル**: `app/core/config.py`

---

## ⚠️ 残存リスクと推奨アクション (Recommended Actions)



### 2. パスワードリセットの検討

- **アクション**: サービスが既に公開されていた場合、安全のために全ユーザーに対してパスワードリセットを依頼することを強く推奨します。

### 3. フロントエンドのトークン管理 (Next Step)

- **現状**: アクセストークン（JWT）を `localStorage` に保存している。
- **推奨**: XSS 脆弱性によるトークン窃取を防ぐため、`HttpOnly Cookie` への保存に変更することを推奨します。

### 4. 依存ライブラリの定期更新

- **アクション**: `requirements.txt` に記載されたライブラリの脆弱性情報を定期的にチェックし、最新版へアップデートしてください。

